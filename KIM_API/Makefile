
#
# Release: This file is part of the openkim-api.git repository.
#
# Copyright 2011 Ellad B. Tadmor, Ryan S. Elliott, and James P. Sethna
# All rights reserved.
#
# Authors: Valeriu Smirichinski, Ryan S. Elliott, Ellad B. Tadmor
#

# load in variable definitions and pattern rules
include Include.mk

# create list of models
MODELS_TARGETS := $(addprefix ., $(addsuffix .make-temp, $(filter-out .%,$(shell find $(KIM_MODELS_DIR) -maxdepth 1 -mindepth 1 -type d -exec basename {} \;))))
# create list of models that have been deleted from the $(KIM_MODELS_DIR) since the last time make was executed
DELETED_MODELS_TARGETS := $(filter-out $(MODELS_TARGETS), $(shell find . -name ".*.make-temp" -exec basename {} \;))
# If there are deleted models, remove files and touch .models-deleted to force a reconfigure 
ifneq ($(DELETED_MODELS_TARGETS),)
   DUMMY:=$(shell rm -f .*.make-temp model_init_include.{h,cpp} && touch .models-deleted)
   $(info Deleted Models: $(patsubst .%.make-temp,%,$(DELETED_MODELS_TARGETS)))
   $(info Must reconfigure all models...)
   $(info )
endif

# default target
all: libkim.a

Makefile: Include.mk
	@touch Makefile

libkim.a: $(ALLOBJ) 
	ar rcs  $@ $(ALLOBJ)

KIMservice.o: model_init_include.h model_init_include.cpp model_kim_str_include.cpp KIMservice.h KIMservice.cpp Makefile

KIMserviceC.o: KIMservice.h KIMserviceC.h Makefile

KIMserviceF.o: Makefile

# targets for the models: for any new model adds the appropriate lines to the model_init_include.{h,cpp} files
$(MODELS_TARGETS): .models-deleted
	@sh -c "if !(grep -i -q -s $(patsubst .%.make-temp,%_init,$@) model_init_include.h); then echo void \* \
	`echo $(patsubst .%.make-temp,%,$@) | tr A-Z a-z`_init_\(void \*\*\)\; >> model_init_include.h;  fi"
	@sh -c "if !(grep -i -q -s $(patsubst .%.make-temp,%_init,$@) model_init_include.cpp); then \
	echo \"\" if\(strcmp\(modelname,\\\"$(patsubst .%.make-temp,%,$@)\\\"\)==0\){ >> model_init_include.cpp;\
	echo \"       \" `echo $(patsubst .%.make-temp,%,$@) | tr A-Z a-z`_init_\(\(void \*\*\) pkim\)\; >> model_init_include.cpp;\
	echo \"       \" return true\; >> model_init_include.cpp;\
	echo \" }\" >> model_init_include.cpp;\
	fi"
	@sh -c "if !(grep -i -q -s $(patsubst .%.make-temp,%_kim_str,$@) model_kim_str_include.h); then echo \
	`echo char\* $(patsubst .%.make-temp,%,$@)`_kim_str'()'\; >> model_kim_str_include.h;  fi"
	@sh -c "if !(grep -i -q -s $(patsubst .%.make-temp,%_kim_str,$@) model_kim_str_include.cpp); then \
	echo \"\" if\(strcmp\(modelname,\\\"$(patsubst .%.make-temp,%,$@)\\\"\)==0\){ >> model_kim_str_include.cpp;\
	echo \"       in_mdlstr = \" `echo $(patsubst .%.make-temp,%,$@)`_kim_str'()'\; >> model_kim_str_include.cpp;\
	echo \" }\" >> model_kim_str_include.cpp;\
	fi"
	@touch $@
	@echo "Configuring Model: $(patsubst .%.make-temp,%,$@)..."

# If .models-deleted doesn't exist or Makefile is newer, delete files and then create .models-deleted.
.models-deleted : Makefile
	@rm -f .*.make-temp model_init_include.{h,cpp} model_kim_str_include.{h,cpp}
	@touch .models-deleted

# dependencies for autogenerated files
model_init_include.h model_init_include.cpp: Makefile .models-deleted $(MODELS_TARGETS)

.PHONY: all tests clean

clean:
	rm -f *.o *.a *.mod  model_init_include.{h,cpp} model_kim_str_include.{h,cpp} .*.make-temp .models-deleted
